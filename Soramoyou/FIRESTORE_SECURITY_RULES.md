# Firestore Security Rules ドキュメント

このドキュメントでは、そらもようアプリで使用するFirestore Security Rulesの設定について説明します。

## デプロイ方法

Firebase CLIを使用してSecurity Rulesをデプロイします：

```bash
firebase deploy --only firestore:rules
```

または、Firebase Consoleから直接編集・デプロイすることもできます。

## セキュリティルールの概要

### 1. Users コレクション

**パス**: `/users/{userId}`

**ルール**:
- **読み取り**: 認証済みユーザーのみ（全ユーザーのプロフィールを閲覧可能）
- **作成**: 認証済みユーザーが自分のデータを作成（`userId`が認証ユーザーIDと一致）
- **更新・削除**: 自分のデータのみ（`userId`が認証ユーザーIDと一致）

**実装の詳細**:
- ドキュメントIDは`userId`（Firebase AuthenticationのUID）と一致
- 作成時は`userId`フィールドがドキュメントIDと一致することを確認
- 更新時は`userId`フィールドの変更を防ぐ

### 2. Posts コレクション

**パス**: `/posts/{postId}`

**ルール**:
- **読み取り**:
  - 公開投稿（`visibility == 'public'`）: 全員読み取り可能（認証不要）
  - フォロワー投稿（`visibility == 'followers'`）: 自分の投稿のみ（Phase 2でフォロワー機能実装後に対応）
  - 非公開投稿（`visibility == 'private'`）: 自分の投稿のみ
  - 自分の投稿: 常に読み取り可能
- **作成**: 認証済みユーザーが自分の投稿を作成（`userId`が認証ユーザーIDと一致、`visibility`が有効な値）
- **更新**: 自分の投稿のみ更新可能（`userId`フィールドの変更を防ぐ）
- **削除**: 自分の投稿のみ削除可能

**実装の詳細**:
- ドキュメントIDは`postId`（UUID）
- 作成時は`userId`フィールドが認証ユーザーIDと一致することを確認
- 更新時は`userId`フィールドの変更を防ぐ
- `visibility`フィールドは`'public'`, `'followers'`, `'private'`のいずれかであることを確認

### 3. Drafts コレクション

**パス**: `/drafts/{draftId}`

**ルール**:
- **読み取り**: 自分の下書きのみ（`userId`が認証ユーザーIDと一致）
- **作成**: 認証済みユーザーが自分の下書きを作成（`userId`が認証ユーザーIDと一致、`draftId`がドキュメントIDと一致）
- **更新**: 自分の下書きのみ更新可能（`userId`フィールドと`draftId`フィールドの変更を防ぐ）
- **削除**: 自分の下書きのみ削除可能

**実装の詳細**:
- ドキュメントIDは`draftId`（UUID）
- 作成時は`userId`フィールドが認証ユーザーIDと一致し、`draftId`フィールドがドキュメントIDと一致することを確認
- 更新時は`userId`フィールドと`draftId`フィールドの変更を防ぐ

## ヘルパー関数

Security Rulesでは以下のヘルパー関数を使用しています：

- `isAuthenticated()`: 認証済みユーザーかどうかを確認
- `isOwner(userId)`: 指定されたユーザーIDが認証ユーザーIDと一致するか確認
- `isPublicPost()`: 投稿が公開設定かどうかを確認
- `isOwnPost()`: 投稿が自分の投稿かどうかを確認
- `isFollowersPost()`: 投稿がフォロワー投稿で、かつ自分の投稿かどうかを確認（Phase 2で実装予定）
- `isPrivatePost()`: 投稿が非公開設定で、かつ自分の投稿かどうかを確認

## セキュリティの考慮事項

### 1. 認証状態の確認

すべての書き込み操作（作成、更新、削除）は認証済みユーザーのみが実行可能です。

### 2. 所有権の確認

ユーザーは自分のデータのみ作成・更新・削除できます。Security Rulesで`userId`フィールドと認証ユーザーIDの一致を確認しています。

### 3. 公開設定に基づくアクセス制御

投稿の公開設定（`public`, `followers`, `private`）に基づいて読み取りアクセスを制御しています。

- **public**: 全員が読み取り可能（認証不要）
- **followers**: 現在は自分の投稿のみ読み取り可能（Phase 2でフォロワー機能実装後に対応）
- **private**: 自分の投稿のみ読み取り可能

### 4. データ整合性の保護

更新操作時に重要なフィールド（`userId`, `draftId`など）の変更を防ぐことで、データ整合性を保護しています。

## テスト方法

Firebase Consoleの「Firestore Database」>「ルール」タブで、ルールのシミュレーションを実行できます。

### テストケース例

1. **Users コレクション**:
   - 認証済みユーザーが自分のデータを読み取れるか
   - 認証済みユーザーが自分のデータを更新できるか
   - 認証済みユーザーが他ユーザーのデータを更新できないか

2. **Posts コレクション**:
   - 未認証ユーザーが公開投稿を読み取れるか
   - 認証済みユーザーが自分の投稿を作成できるか
   - 認証済みユーザーが他ユーザーの投稿を更新できないか

3. **Drafts コレクション**:
   - 認証済みユーザーが自分の下書きを読み取れるか
   - 認証済みユーザーが自分の下書きを作成できるか
   - 認証済みユーザーが他ユーザーの下書きを読み取れないか

## 今後の改善

- **Phase 2**: フォロワー機能実装後、フォロワー投稿の読み取りルールを更新
- **Phase 2**: いいね・コメント機能実装後、関連するSecurity Rulesを追加


