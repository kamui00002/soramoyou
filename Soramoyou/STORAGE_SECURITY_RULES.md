# Firebase Storage Security Rules ドキュメント

このドキュメントでは、そらもようアプリで使用するFirebase Storage Security Rulesの設定について説明します。

## デプロイ方法

Firebase CLIを使用してSecurity Rulesをデプロイします：

```bash
firebase deploy --only storage
```

または、Firebase Consoleから直接編集・デプロイすることもできます。

## セキュリティルールの概要

### 1. Posts Images (投稿画像)

**パス**: `/posts/{userId}/{imageId}.jpg`

**ルール**:
- **読み取り**: 全員読み取り可能（公開投稿の画像）
- **アップロード**: 認証済みユーザーが自分の投稿画像をアップロード
  - `userId`が認証ユーザーIDと一致
  - ファイルサイズが5MB以下
  - コンテンツタイプが画像形式
- **削除**: 自分の投稿画像のみ削除可能

**実装の詳細**:
- 投稿画像は公開投稿として扱われ、全員が読み取り可能
- アップロード時は認証必須で、自分のユーザーIDのパスにのみアップロード可能
- ファイルサイズとコンテンツタイプの検証を実施

### 2. Thumbnails (サムネイル画像)

**パス**: `/thumbnails/{userId}/{imageId}.jpg`

**ルール**:
- **読み取り**: 全員読み取り可能（公開投稿のサムネイル）
- **アップロード**: 認証済みユーザーが自分のサムネイルをアップロード
  - `userId`が認証ユーザーIDと一致
  - ファイルサイズが1MB以下（サムネイル用）
  - コンテンツタイプが画像形式
- **削除**: 自分のサムネイルのみ削除可能

**実装の詳細**:
- サムネイル画像は公開投稿として扱われ、全員が読み取り可能
- アップロード時は認証必須で、自分のユーザーIDのパスにのみアップロード可能
- サムネイル用のファイルサイズ制限（1MB）を設定

### 3. User Profile Images (プロフィール画像)

**パス**: `/users/{userId}/profile.jpg`

**ルール**:
- **読み取り**: 全員読み取り可能（プロフィール画像は公開）
- **アップロード**: 認証済みユーザーが自分のプロフィール画像をアップロード
  - `userId`が認証ユーザーIDと一致
  - ファイルサイズが5MB以下
  - コンテンツタイプが画像形式
- **削除**: 自分のプロフィール画像のみ削除可能

**実装の詳細**:
- プロフィール画像は公開として扱われ、全員が読み取り可能
- アップロード時は認証必須で、自分のユーザーIDのパスにのみアップロード可能
- ファイルサイズとコンテンツタイプの検証を実施

### 4. その他のパス

**パス**: `/{allPaths=**}`

**ルール**:
- **すべてのアクセスを拒否**: 明示的に許可されていないパスはすべて拒否

**実装の詳細**:
- セキュリティを強化するため、明示的に許可されていないパスへのアクセスを拒否
- 将来の拡張時に新しいパスパターンを追加する必要がある

## ヘルパー関数

Security Rulesでは以下のヘルパー関数を使用しています：

- `isAuthenticated()`: 認証済みユーザーかどうかを確認
- `isOwner(userId)`: 指定されたユーザーIDが認証ユーザーIDと一致するか確認

## セキュリティの考慮事項

### 1. 認証状態の確認

すべての書き込み操作（アップロード、削除）は認証済みユーザーのみが実行可能です。

### 2. 所有権の確認

ユーザーは自分のユーザーIDのパスにのみ画像をアップロード・削除できます。Security Rulesで`userId`と認証ユーザーIDの一致を確認しています。

### 3. ファイルサイズの制限

- 投稿画像・プロフィール画像: 5MB以下
- サムネイル画像: 1MB以下

### 4. コンテンツタイプの検証

すべての画像ファイルは`image/*`形式であることを確認しています。

### 5. 公開設定

現在の実装では、すべての画像を公開として扱っています。投稿画像は公開投稿の画像として、プロフィール画像は公開プロフィール画像として扱われます。

## パス構造

### 投稿画像
```
posts/{userId}/{imageId}.jpg
例: posts/user123/uuid-456.jpg
```

### サムネイル画像
```
thumbnails/{userId}/{imageId}.jpg
例: thumbnails/user123/uuid-456.jpg
```

### プロフィール画像
```
users/{userId}/profile.jpg
例: users/user123/profile.jpg
```

## テスト方法

Firebase Consoleの「Storage」>「ルール」タブで、ルールのシミュレーションを実行できます。

### テストケース例

1. **Posts Images**:
   - 未認証ユーザーが投稿画像を読み取れるか
   - 認証済みユーザーが自分の投稿画像をアップロードできるか
   - 認証済みユーザーが他ユーザーの投稿画像をアップロードできないか

2. **Thumbnails**:
   - 未認証ユーザーがサムネイルを読み取れるか
   - 認証済みユーザーが自分のサムネイルをアップロードできるか

3. **Profile Images**:
   - 未認証ユーザーがプロフィール画像を読み取れるか
   - 認証済みユーザーが自分のプロフィール画像をアップロードできるか
   - 認証済みユーザーが他ユーザーのプロフィール画像をアップロードできないか

## 今後の改善

- **Phase 2**: プライベート投稿の画像を非公開にする場合、Storage Rulesを更新
- **Phase 2**: フォロワー投稿の画像をフォロワーのみ閲覧可能にする場合、Storage Rulesを更新


