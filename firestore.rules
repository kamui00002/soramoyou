rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper functions
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // Data Validation functions
    // ============================================

    // キャプションの長さ検証（最大2000文字）
    function isValidCaption(caption) {
      return caption == null || caption.size() <= 2000;
    }

    // ハッシュタグの検証（最大30個）
    function isValidHashtags(hashtags) {
      return hashtags == null || hashtags.size() <= 30;
    }

    // 可視性の検証
    function isValidVisibility(visibility) {
      return visibility in ['public', 'followers', 'private'];
    }

    // 投稿データの検証
    function isValidPost() {
      let data = request.resource.data;
      return data.keys().hasAll(['userId', 'images', 'visibility', 'createdAt'])
             && isValidCaption(data.get('caption', null))
             && isValidHashtags(data.get('hashtags', null))
             && isValidVisibility(data.visibility)
             && data.images.size() >= 1
             && data.images.size() <= 10;
    }

    // ============================================
    // Users collection
    // ============================================
    match /users/{userId} {
      // 認証済みユーザーのみプロフィールを読み取り可能
      // （プライバシー保護のため）
      allow read: if isAuthenticated();

      // 新規ユーザーのみ自分のプロフィールを作成可能
      allow create: if isOwner(userId)
                    && request.resource.data.keys().hasAll(['id', 'email', 'createdAt']);

      // 所有者のみ更新・削除可能
      // idとemailは変更不可
      allow update: if isOwner(userId)
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.email == resource.data.email;

      allow delete: if isOwner(userId);
    }

    // ============================================
    // Posts collection
    // ============================================
    match /posts/{postId} {
      // 読み取り権限
      // - public: 誰でも読み取り可能
      // - followers: Phase 1では所有者のみ（Phase 2でフォロワーチェックを実装予定）
      //   TODO: Phase 2で follows コレクションを使ったフォロワー検証を追加
      //   例: exists(/databases/$(database)/documents/follows/$(request.auth.uid + '_' + resource.data.userId))
      // - private: 所有者のみ
      allow read: if resource.data.visibility == 'public'
                  || isOwner(resource.data.userId);

      // 作成権限: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && isValidPost();

      // 更新・削除権限: 所有者のみ
      // userIdは変更不可
      allow update: if isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId
                    && isValidPost();

      allow delete: if isOwner(resource.data.userId);
    }

    // ============================================
    // Drafts collection
    // ============================================
    match /drafts/{draftId} {
      // 読み取り: 所有者のみ（下書きは完全にプライベート）
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // 作成: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['id', 'userId', 'createdAt']);

      // 更新: 所有者のみ、userIdは変更不可
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId;

      // 削除: 所有者のみ
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }
  }
}
