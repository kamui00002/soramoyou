rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper functions
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // フォロー関係をチェック（followerId_followeeId 形式のドキュメントID）
    function isFollowing(followeeId) {
      let followId = request.auth.uid + '_' + followeeId;
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/follows/$(followId));
    }

    // ============================================
    // Data Validation functions
    // ============================================

    // キャプションの長さ検証（最大2000文字）
    function isValidCaption(caption) {
      return caption == null || caption.size() <= 2000;
    }

    // ハッシュタグの検証（最大30個）
    function isValidHashtags(hashtags) {
      return hashtags == null || hashtags.size() <= 30;
    }

    // 可視性の検証
    function isValidVisibility(visibility) {
      return visibility in ['public', 'followers', 'private'];
    }

    // メールアドレスの検証（より厳密な正規表現）
    // 匿名ユーザー（Anonymous Auth）はemailを持たないため、nullも許可する
    function isValidEmail(email) {
      return email == null
             || (email is string
                 && email.size() > 0
                 && email.size() <= 254
                 && email.matches('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}'));
    }

    // 投稿データの検証
    function isValidPost() {
      let data = request.resource.data;
      return data.keys().hasAll(['userId', 'images', 'visibility', 'createdAt'])
             && isValidCaption(data.get('caption', null))
             && isValidHashtags(data.get('hashtags', null))
             && isValidVisibility(data.visibility)
             && data.images.size() >= 1
             && data.images.size() <= 10;
    }

    // 投稿更新時のカウントフィールド検証（改ざん防止）
    // 投稿オーナーによる更新ではカウントフィールドの変更を禁止
    function isValidPostUpdate() {
      let data = request.resource.data;
      let existing = resource.data;
      return isValidPost()
             && data.likesCount == existing.likesCount
             && data.commentsCount == existing.commentsCount;
    }

    // いいね/コメントによるカウント更新の検証
    // カウントフィールド以外の変更を禁止する
    // 各カウントは独立して検証され、いずれも変更なし or ±1 のみ許可
    // フィールド数が同一であることを検証（余分なフィールド追加を防ぐ）
    function isCountOnlyUpdate() {
      let data = request.resource.data;
      let existing = resource.data;
      return data.keys().size() == existing.keys().size()
             && data.userId == existing.userId
             && data.images == existing.images
             && data.visibility == existing.visibility
             && data.createdAt == existing.createdAt
             && data.get('caption', null) == existing.get('caption', null)
             && data.get('hashtags', null) == existing.get('hashtags', null)
             // likesCountは変更なし or ±1 のみ許可
             && (data.likesCount == existing.likesCount
                 || data.likesCount == existing.likesCount + 1
                 || data.likesCount == existing.likesCount - 1)
             // commentsCountは変更なし or ±1 のみ許可
             && (data.commentsCount == existing.commentsCount
                 || data.commentsCount == existing.commentsCount + 1
                 || data.commentsCount == existing.commentsCount - 1);
    }

    // 投稿の所有者かどうかを確認
    function isPostOwner(postId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/posts/$(postId)).data.userId == request.auth.uid;
    }

    // ============================================
    // Users collection (機密情報のみ - 所有者のみアクセス可能)
    // ============================================
    match /users/{userId} {
      // 機密情報（email, blockedUserIds等）は所有者のみ読み取り可能
      allow read: if isOwner(userId);

      // 新規ユーザーのみ自分のプロフィールを作成可能
      // 匿名ユーザーはemailを持たないため、emailフィールドは必須としない
      allow create: if isOwner(userId)
                    && request.resource.data.keys().hasAll(['id', 'createdAt'])
                    && isValidEmail(request.resource.data.get('email', null));

      // 所有者のみ更新可能
      // idは変更不可。emailは存在する場合のみ変更不可（匿名ユーザーはemailなし）
      allow update: if isOwner(userId)
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.get('email', null) == resource.data.get('email', null);

      allow delete: if isOwner(userId);
    }

    // ============================================
    // Public Profiles collection (公開プロフィール情報)
    // ============================================
    match /publicProfiles/{userId} {
      // 公開プロフィール情報は認証済みユーザーが読み取り可能
      allow get: if isAuthenticated();
      allow list: if isAuthenticated() && request.query.limit <= 20;

      // 所有者のみ作成・更新・削除可能
      allow create: if isOwner(userId)
                    && request.resource.data.keys().hasAll(['id', 'createdAt']);

      allow update: if isOwner(userId)
                    && request.resource.data.id == resource.data.id;

      allow delete: if isOwner(userId);
    }

    // ============================================
    // Follows collection (フォロー関係)
    // ドキュメントID: {followerId}_{followeeId}
    // ============================================
    match /follows/{followId} {
      // フォロー関係は認証済みユーザーが確認可能
      allow read: if isAuthenticated();

      // フォロー作成: 自分がフォロワーの場合のみ
      allow create: if isAuthenticated()
                    && request.resource.data.followerId == request.auth.uid
                    && followId == request.auth.uid + '_' + request.resource.data.followeeId
                    && request.resource.data.keys().hasAll(['followerId', 'followeeId', 'createdAt']);

      // フォロー解除: 自分のフォローのみ削除可能
      allow delete: if isAuthenticated()
                    && resource.data.followerId == request.auth.uid;

      // フォロー関係の更新は不可
      allow update: if false;
    }

    // ============================================
    // Posts collection
    // ============================================
    match /posts/{postId} {
      // 読み取り権限
      // - public: 誰でも読み取り可能（ゲスト・未認証ユーザー含む）
      // - followers: フォロワーのみ読み取り可能（認証必須）
      // - private: 所有者のみ（認証必須）
      allow read: if resource.data.visibility == 'public'
                  || (resource.data.visibility == 'followers' && isFollowing(resource.data.userId))
                  || isOwner(resource.data.userId);

      // 作成権限: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && isValidPost();

      // 更新権限:
      // 1. 所有者による編集（カウント改ざん不可）
      // 2. 認証済みユーザーによるカウント更新（いいね/コメントのトランザクション）
      allow update: if (isOwner(resource.data.userId)
                        && request.resource.data.userId == resource.data.userId
                        && isValidPostUpdate())
                    || (isAuthenticated() && isCountOnlyUpdate());

      // 削除権限: 所有者のみ
      allow delete: if isOwner(resource.data.userId);
    }

    // ============================================
    // Drafts collection
    // ============================================
    match /drafts/{draftId} {
      // 読み取り: 所有者のみ（下書きは完全にプライベート）
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // 作成: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['id', 'userId', 'createdAt']);

      // 更新: 所有者のみ、userIdは変更不可
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId;

      // 削除: 所有者のみ
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // Likes collection (いいね)
    // ドキュメントID: {userId}_{postId}
    // ============================================
    match /likes/{likeId} {
      // 読み取り権限: 自分のいいね、または投稿の所有者
      allow read: if isAuthenticated()
                  && (resource.data.userId == request.auth.uid
                      || isPostOwner(resource.data.postId));

      // いいね作成: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && likeId == request.auth.uid + '_' + request.resource.data.postId
                    && request.resource.data.keys().hasAll(['userId', 'postId', 'createdAt']);

      // いいね削除: 自分のいいねのみ削除可能
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // いいねの更新は不可
      allow update: if false;
    }

    // ============================================
    // Comments collection (コメント)
    // ============================================
    match /comments/{commentId} {
      // コメントは認証済みユーザーが読み取り可能
      // TODO: Phase 2でコメント機能実装時に、投稿の可視性と連動させる
      // （非公開投稿のコメントはオーナーのみ、フォロワー限定はフォロワーのみ読み取り可能にする）
      allow read: if isAuthenticated();

      // コメント作成: 認証済みユーザーのみ、自分のIDで作成
      // TODO: Phase 2で投稿の可視性に基づくアクセス制御を追加
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'postId', 'content', 'createdAt'])
                    && request.resource.data.content.size() >= 1
                    && request.resource.data.content.size() <= 500;

      // コメント更新: 自分のコメントのみ、内容のみ更新可能
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.postId == resource.data.postId
                    && request.resource.data.content.size() >= 1
                    && request.resource.data.content.size() <= 500;

      // コメント削除: 自分のコメント、または投稿の所有者（モデレーション）
      allow delete: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || isPostOwner(resource.data.postId));
    }

    // ============================================
    // Reports collection (通報)
    // ============================================
    match /reports/{reportId} {
      // 通報は管理者のみ読み取り可能（Cloud Functions経由）
      allow read: if false;

      // 通報作成: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.reporterId == request.auth.uid
                    && request.resource.data.keys().hasAll(['postId', 'reporterId', 'reportedUserId', 'reason', 'createdAt']);

      // 通報の更新・削除は不可
      allow update, delete: if false;
    }

    // ============================================
    // Collections collection (コレクション)
    // ============================================
    match /collections/{collectionId} {
      // コレクションは所有者のみ読み取り可能
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // コレクション作成: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'name', 'createdAt'])
                    && request.resource.data.name.size() >= 1
                    && request.resource.data.name.size() <= 50;

      // コレクション更新: 所有者のみ
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.name.size() >= 1
                    && request.resource.data.name.size() <= 50;

      // コレクション削除: 所有者のみ
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // CollectionItems collection (コレクションアイテム)
    // ドキュメントID: {collectionId}_{postId}
    // ============================================
    match /collectionItems/{itemId} {
      // コレクションの所有者のみ読み取り可能
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // アイテム追加: コレクションの所有者のみ
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && itemId == request.resource.data.collectionId + '_' + request.resource.data.postId
                    && request.resource.data.keys().hasAll(['userId', 'collectionId', 'postId', 'createdAt']);

      // アイテム削除: 所有者のみ
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;

      // アイテムの更新は不可
      allow update: if false;
    }
  }
}
