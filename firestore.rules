rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper functions
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isFollower(userId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/follows/$(request.auth.uid + '_' + userId));
    }

    // ============================================
    // Data Validation functions
    // ============================================

    // キャプションの長さ検証（最大2000文字）
    function isValidCaption(caption) {
      return caption == null || caption.size() <= 2000;
    }

    // ハッシュタグの検証（最大30個）
    function isValidHashtags(hashtags) {
      return hashtags == null || hashtags.size() <= 30;
    }

    // 可視性の検証
    function isValidVisibility(visibility) {
      return visibility in ['public', 'followers', 'private'];
    }

    // 投稿データの検証
    function isValidPost() {
      let data = request.resource.data;
      return data.keys().hasAll(['postId', 'userId', 'images', 'visibility', 'createdAt'])
             && data.postId == request.resource.id
             && isValidCaption(data.get('caption', null))
             && isValidHashtags(data.get('hashtags', null))
             && isValidVisibility(data.visibility)
             && data.images.size() >= 1
             && data.images.size() <= 10;
    }

    // ============================================
    // Users collection
    // ============================================
    match /users/{userId} {
      // 認証済みユーザーのみプロフィールを読み取り可能
      // （プライバシー保護のため）
      allow read: if isAuthenticated();

      // 新規ユーザーのみ自分のプロフィールを作成可能
      allow create: if isOwner(userId)
                    && request.resource.data.keys().hasAll(['id', 'createdAt'])
                    && (request.resource.data.email == null
                        || request.resource.data.email == request.auth.token.email);

      // 所有者のみ更新・削除可能
      // idは変更不可、emailは変更不可（nullから設定する場合は許可）
      allow update: if isOwner(userId)
                    && (
                      // idフィールドが存在しない、または変更されていない
                      !request.resource.data.keys().hasAny(['id'])
                      || request.resource.data.id == resource.data.id
                    )
                    && (
                      // emailフィールドが存在しない、または
                      // 変更されていない、または
                      // nullから認証メールへの設定のみ許可
                      !request.resource.data.keys().hasAny(['email'])
                      || request.resource.data.email == resource.data.email
                      || (resource.data.email == null
                          && request.resource.data.email == request.auth.token.email)
                    );

      allow delete: if isOwner(userId);
    }

    // ============================================
    // Posts collection
    // ============================================
    match /posts/{postId} {
      // 読み取り権限
      // - public: 誰でも読み取り可能
      // - followers: 所有者またはフォロワーのみ
      //   follows コレクションを使ったフォロワー検証
      // - private: 所有者のみ
      allow read: if resource.data.visibility == 'public'
                  || (resource.data.visibility == 'followers'
                      && (isOwner(resource.data.userId) || isFollower(resource.data.userId)))
                  || (resource.data.visibility == 'private'
                      && isOwner(resource.data.userId));

      // 作成権限: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && isValidPost();

      // 更新・削除権限: 所有者のみ
      // userIdは変更不可、createdAtは変更不可
      allow update: if isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.createdAt == resource.data.createdAt
                    && isValidPost();

      allow delete: if isOwner(resource.data.userId);
    }

    // ============================================
    // Drafts collection
    // ============================================
    match /drafts/{draftId} {
      // 読み取り: 所有者のみ（下書きは完全にプライベート）
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // 作成: 認証済みユーザーのみ、自分のIDで作成
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['id', 'userId', 'createdAt']);

      // 更新: 所有者のみ、userIdは変更不可
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId;

      // 削除: 所有者のみ
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }
  }
}
