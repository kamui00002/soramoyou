# Requirements Document

## Introduction
そらもようは、空の写真を投稿・編集・共有するSNSアプリです。ユーザーは空の写真を撮影または選択し、豊富な編集ツールとフィルターで加工して投稿できます。他のユーザーの投稿を閲覧し、ハッシュタグや色、時間帯、空の種類で検索することができます。Phase 1（MVP）では、基本的な投稿・閲覧・検索機能を実装します。

## Requirements

### Requirement 1: ユーザー認証
**Objective:** ユーザーとして、アカウントを作成してログインしたい。これにより、投稿やプロフィール管理などの機能を利用できる。

#### Acceptance Criteria
1. When アプリが初めて起動されたとき, the そらもようシステム shall ウェルカム画面を表示する
2. When ユーザーが新規登録ボタンをタップしたとき, the そらもようシステム shall 新規登録画面を表示する
3. When ユーザーがメールアドレスとパスワードを入力して登録したとき, the そらもようシステム shall Firebase Authenticationでアカウントを作成する
4. When ユーザーがログインボタンをタップしたとき, the そらもようシステム shall ログイン画面を表示する
5. When ユーザーがメールアドレスとパスワードを入力してログインしたとき, the そらもようシステム shall Firebase Authenticationで認証を行う
6. If 認証に失敗したとき, the そらもようシステム shall エラーメッセージを表示する
7. When 認証に成功したとき, the そらもようシステム shall ホーム画面に遷移する
8. The そらもようシステム shall 認証状態を保持し、次回起動時に自動ログインする

### Requirement 2: 写真選択機能
**Objective:** ユーザーとして、カメラロールから空の写真を選択したい。これにより、投稿する写真を選ぶことができる。

#### Acceptance Criteria
1. When ユーザーがタブバーの「投稿」ボタンをタップしたとき, the そらもようシステム shall 写真選択画面を表示する
2. When 写真選択画面が表示されたとき, the そらもようシステム shall カメラロールへのアクセス許可を求める
3. When ユーザーが写真を選択したとき, the そらもようシステム shall 選択した写真をプレビュー表示する
4. When 未ログインユーザーが写真を選択したとき, the そらもようシステム shall 最大3枚まで選択可能にする
5. When ログイン済みユーザーが写真を選択したとき, the そらもようシステム shall 最大10枚まで選択可能にする
6. If 選択可能な枚数を超えたとき, the そらもようシステム shall エラーメッセージを表示する
7. When ユーザーが写真選択を完了したとき, the そらもようシステム shall 編集画面に遷移する
8. The そらもようシステム shall 選択した写真が最大解像度2048×2048ピクセル、ファイルサイズ5MB以下であることを確認する

### Requirement 3: 画像編集機能（フィルター）
**Objective:** ユーザーとして、選択した写真にフィルターを適用したい。これにより、写真を美しく加工できる。

#### Acceptance Criteria
1. When 編集画面が表示されたとき, the そらもようシステム shall 10種類のフィルター（ナチュラル、クリア、ドラマ、ソフト、ウォーム、クール、ビンテージ、モノクロ、パステル、ヴィヴィッド）を表示する
2. When ユーザーがフィルターを選択したとき, the そらもようシステム shall リアルタイムでプレビューに適用する
3. When ユーザーが別のフィルターを選択したとき, the そらもようシステム shall 前のフィルターを解除して新しいフィルターを適用する
4. When ユーザーがフィルターなしを選択したとき, the そらもようシステム shall 元の画像を表示する
5. The そらもようシステム shall Core Image / CIFilterを使用してフィルターを適用する

### Requirement 4: 画像編集機能（基本編集ツール）
**Objective:** ユーザーとして、写真の明るさや色調などを調整したい。これにより、より細かく写真を編集できる。

#### Acceptance Criteria
1. When ユーザーが編集ツールボタンをタップしたとき, the そらもようシステム shall 装備している編集ツールのリストを表示する
2. When ユーザーが編集ツールを選択したとき, the そらもようシステム shall そのツールの調整スライダーを表示する
3. When ユーザーがスライダーを操作したとき, the そらもようシステム shall リアルタイムでプレビューに反映する
4. The そらもようシステム shall 27種類の基本編集ツール（露出、明るさ、コントラスト、トーン、ブリリアンス、ハイライト、シャドウ、ブラックポイント、彩度、自然な彩度、暖かみ、色合い、シャープネス、ビネット、色温度、ホワイトバランス、テクスチャ、クラリティ、かすみの除去、グレイン、フェード、ノイズリダクション、カーブ調整、HSL調整、レンズ補正、二重露光風合成、トリミング・回転）を提供する
5. When ユーザーが装備していないツールを選択しようとしたとき, the そらもようシステム shall 装備設定画面への案内を表示する

### Requirement 5: 編集装備システム
**Objective:** ユーザーとして、よく使う編集ツールを選択して表示順をカスタマイズしたい。これにより、効率的に写真を編集できる。

#### Acceptance Criteria
1. When ユーザーが設定画面から編集装備設定を選択したとき, the そらもようシステム shall 27種類の編集ツール一覧を表示する
2. When ユーザーが編集ツールを選択したとき, the そらもようシステム shall そのツールを装備リストに追加する
3. When ユーザーが装備ツールを5〜8個選択したとき, the そらもようシステム shall 選択したツールのみを編集画面に表示する
4. When ユーザーが装備ツールの順序をドラッグ&ドロップで変更したとき, the そらもようシステム shall その順序を保存する
5. When ユーザーが装備ツールを解除したとき, the そらもようシステム shall そのツールを装備リストから削除する
6. The そらもようシステム shall 装備情報をFirestoreのusersコレクションのcustomEditToolsとcustomEditToolsOrderフィールドに保存する
7. When ユーザーが編集画面を開いたとき, the そらもようシステム shall 保存された装備ツールと順序を表示する

### Requirement 6: 投稿情報入力機能
**Objective:** ユーザーとして、投稿にキャプションやハッシュタグ、位置情報を追加したい。これにより、投稿に情報を付加できる。

#### Acceptance Criteria
1. When ユーザーが編集を完了して次へ進んだとき, the そらもようシステム shall 投稿情報入力画面を表示する
2. When 投稿情報入力画面が表示されたとき, the そらもようシステム shall 編集済み写真のプレビューを表示する
3. When ユーザーがキャプションを入力したとき, the そらもようシステム shall その内容を保存する
4. When ユーザーがハッシュタグを入力したとき, the そらもようシステム shall ハッシュタグを抽出して保存する
5. When ユーザーが位置情報を追加するボタンをタップしたとき, the そらもようシステム shall 位置情報の使用許可を求める
6. When ユーザーが位置情報の使用を許可したとき, the そらもようシステム shall 現在地を取得して市区町村レベルで表示する
7. When ユーザーが地図から目標物を選択したとき, the そらもようシステム shall そのランドマーク情報を保存する
8. When ユーザーが公開設定を選択したとき, the そらもようシステム shall その設定（public / followers / private）を保存する
9. When ユーザーが投稿ボタンをタップしたとき, the そらもようシステム shall 投稿情報を保存する

### Requirement 7: 自動情報抽出機能
**Objective:** ユーザーとして、写真から自動的に情報を抽出したい。これにより、手動入力の手間を減らせる。

#### Acceptance Criteria
1. When ユーザーが写真を選択したとき, the そらもようシステム shall EXIF情報から撮影時刻を取得する
2. When 撮影時刻が取得されたとき, the そらもようシステム shall 時間帯（morning / afternoon / evening / night）を自動判定する
3. When 写真が読み込まれたとき, the そらもようシステム shall 画像から主要な色を最大5色抽出する
4. When 色が抽出されたとき, the そらもようシステム shall 16進数カラーコードとして保存する
5. When 写真が読み込まれたとき, the そらもようシステム shall 色温度（K表示）を計算して保存する
6. When 写真が読み込まれたとき, the そらもようシステム shall 空の種類（clear / cloudy / sunset / sunrise / storm）を自動判定する
7. The そらもようシステム shall 抽出した情報を投稿データに含めて保存する

### Requirement 8: 投稿保存機能
**Objective:** ユーザーとして、編集した写真と投稿情報を保存したい。これにより、投稿を公開できる。

#### Acceptance Criteria
1. When ユーザーが投稿ボタンをタップしたとき, the そらもようシステム shall 編集済み画像をJPEG形式（圧縮率80-90%）で圧縮する
2. When 画像の圧縮が完了したとき, the そらもようシステム shall Firebase Storageに画像をアップロードする
3. When 画像のアップロードが成功したとき, the そらもようシステム shall サムネイル画像を生成してアップロードする
4. When 画像のアップロードが完了したとき, the そらもようシステム shall Firestoreのpostsコレクションに投稿データを保存する
5. When 投稿データが保存されたとき, the そらもようシステム shall 投稿完了画面を表示する
6. If 画像のアップロードに失敗したとき, the そらもようシステム shall エラーメッセージを表示する
7. If Firestoreへの保存に失敗したとき, the そらもようシステム shall エラーメッセージを表示する
8. When 投稿が成功したとき, the そらもようシステム shall ホーム画面に遷移する

### Requirement 9: 下書き保存機能
**Objective:** ユーザーとして、編集中の投稿を下書きとして保存したい。これにより、後で続きから編集できる。

#### Acceptance Criteria
1. When ユーザーが下書き保存ボタンをタップしたとき, the そらもようシステム shall 現在の編集状態と投稿情報をdraftsコレクションに保存する
2. When 下書きが保存されたとき, the そらもようシステム shall 下書き保存完了のメッセージを表示する
3. When ユーザーが下書き一覧画面を開いたとき, the そらもようシステム shall 保存された下書きの一覧を表示する
4. When ユーザーが下書きを選択したとき, the そらもようシステム shall 編集画面または投稿情報入力画面に戻す
5. When ユーザーが下書きを削除したとき, the そらもようシステム shall その下書きをFirestoreから削除する

### Requirement 10: フィード表示機能
**Objective:** ユーザーとして、他のユーザーの投稿を閲覧したい。これにより、様々な空の写真を楽しめる。

#### Acceptance Criteria
1. When ユーザーがホーム画面を開いたとき, the そらもようシステム shall 公開設定がpublicの投稿を時系列順で表示する
2. When フィードが表示されたとき, the そらもようシステム shall サムネイル画像を優先的に読み込む
3. When ユーザーが投稿をタップしたとき, the そらもようシステム shall 投稿詳細画面に遷移する
4. When 投稿詳細画面が表示されたとき, the そらもようシステム shall フルサイズの画像、キャプション、ハッシュタグ、位置情報、投稿者情報を表示する
5. When ユーザーがスクロールして画面下部に到達したとき, the そらもようシステム shall 次のページの投稿を読み込む（ページネーション）
6. While 投稿を読み込み中である間, the そらもようシステム shall ローディングインジケーターを表示する
7. The そらもようシステム shall 画像の遅延読み込み（LazyLoad）を実装する

### Requirement 11: 検索機能
**Objective:** ユーザーとして、ハッシュタグや色、時間帯、空の種類で投稿を検索したい。これにより、興味のある投稿を見つけられる。

#### Acceptance Criteria
1. When ユーザーがタブバーの「検索」ボタンをタップしたとき, the そらもようシステム shall 検索画面を表示する
2. When ユーザーがハッシュタグを入力したとき, the そらもようシステム shall そのハッシュタグを含む投稿を検索する
3. When ユーザーが色を選択したとき, the そらもようシステム shall 抽出された色から該当する投稿を検索する
4. When ユーザーが時間帯（morning / afternoon / evening / night）を選択したとき, the そらもようシステム shall その時間帯の投稿を検索する
5. When ユーザーが空の種類（clear / cloudy / sunset / sunrise / storm）を選択したとき, the そらもようシステム shall その種類の投稿を検索する
6. When 検索結果が取得されたとき, the そらもようシステム shall 検索結果一覧画面に表示する
7. When ユーザーが検索結果の投稿をタップしたとき, the そらもようシステム shall 投稿詳細画面に遷移する

### Requirement 12: プロフィール機能
**Objective:** ユーザーとして、自分のプロフィールを表示・編集したい。これにより、自分の情報を管理できる。

#### Acceptance Criteria
1. When ユーザーがタブバーの「プロフィール」ボタンをタップしたとき, the そらもようシステム shall 自分のプロフィール画面を表示する
2. When プロフィール画面が表示されたとき, the そらもようシステム shall プロフィール画像、表示名、自己紹介、投稿数、フォロワー数、フォロー数を表示する
3. When プロフィール画面が表示されたとき, the そらもようシステム shall 自分の投稿一覧を表示する
4. When ユーザーがプロフィール編集ボタンをタップしたとき, the そらもようシステム shall プロフィール編集画面を表示する
5. When ユーザーが表示名や自己紹介を変更したとき, the そらもようシステム shall Firestoreのusersコレクションを更新する
6. When ユーザーがプロフィール画像を変更したとき, the そらもようシステム shall 新しい画像をFirebase Storageにアップロードして更新する
7. When ユーザーが他ユーザーのプロフィールをタップしたとき, the そらもようシステム shall そのユーザーのプロフィール画面を表示する
8. When 他ユーザーのプロフィール画面が表示されたとき, the そらもようシステム shall 公開設定がpublicの投稿のみを表示する

### Requirement 13: AdMob広告表示機能
**Objective:** アプリ運営者として、収益を得るために広告を表示したい。これにより、アプリを継続的に運営できる。

#### Acceptance Criteria
1. When ホーム画面が表示されたとき, the そらもようシステム shall 画面下部にAdMobバナー広告を固定表示する
2. When 他の画面が表示されたとき, the そらもようシステム shall 画面下部にAdMobバナー広告を固定表示する
3. When 広告の読み込みに失敗したとき, the そらもようシステム shall エラーをログに記録するが、アプリの動作には影響を与えない
4. The そらもようシステム shall Google Mobile Ads SDKを使用して広告を表示する

### Requirement 14: 画像仕様とパフォーマンス
**Objective:** システムとして、適切な画像サイズとパフォーマンスを維持したい。これにより、快適にアプリを利用できる。

#### Acceptance Criteria
1. When 画像がアップロードされる前, the そらもようシステム shall 最大解像度2048×2048ピクセルにリサイズする
2. When 画像がアップロードされる前, the そらもようシステム shall ファイルサイズが5MB以下になるように圧縮する
3. When 画像が保存される前, the そらもようシステム shall JPEG形式（圧縮率80-90%）で保存する
4. When サムネイルが生成される前, the そらもようシステム shall 表示用のサムネイル画像を自動生成する
5. The そらもようシステム shall 画像の遅延読み込みを実装して通信量を削減する
6. The そらもようシステム shall 画像キャッシュ（Kingfisher or SDWebImageSwiftUI）を使用して読み込み速度を向上させる

### Requirement 15: セキュリティとアクセス制御
**Objective:** システムとして、ユーザーデータのセキュリティを確保したい。これにより、適切なアクセス制御ができる。

#### Acceptance Criteria
1. When ユーザーが自分のデータにアクセスするとき, the そらもようシステム shall Firebase Security Rulesで認証状態を確認する
2. When ユーザーが投稿を編集・削除しようとしたとき, the そらもようシステム shall その投稿の所有者であることを確認する
3. When ユーザーが他ユーザーの投稿を閲覧しようとしたとき, the そらもようシステム shall 公開設定（public / followers / private）に応じてアクセスを制御する
4. When 画像がアップロードされる前, the そらもようシステム shall 適切なアクセス権限を設定する
5. The そらもようシステム shall APIキーを環境変数で管理し、.gitignoreに追加する


